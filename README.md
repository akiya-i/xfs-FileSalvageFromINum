Get FILES from XFS filesystem by iNode number.
XFSファイルシステムからiNode番号でファイル吸い出し
===========
壊れたNASのディスクからファイルを救い出すのに作ったperlスクリプトです。

NASからHDDを取り出し、linuxのPCにつないでmdadmでNASが使っていたようにRAIDのパーティションを組み上げ、
単一のxfsファイルシステムイメージとしてアクセスできてreadonlyでマウントはできたものの、
ファイルシステムが損傷していて、 rootフォルダは空でファイルが何も無いがファイルシステムとしての使用済領域は適当に食ってる感じのボリュームになってました。ファイルシステム中にはiNodeが残ってるものの、そのリンクが切れていることが推察されます。

さて、ここからどうファイルを救い出すかと考え、作ったスクリプトです。


xfsファイルシステムの修復
----
xfs_repairという標準ツールが用意されていますが、私のボリュームでは、xfs_repairがcore dumpしてダメでした。
xfsの本家からいろいろなバージョンを引っ張ってきて、コンパイルして試してみるも、何もダメ。

xfs_ncheck
-----
それでもxfs_ncheckという標準ツールで、inode番号とファイル名の対応表は取れました。
    xfs_ncheck /dev/md13 > filelist.txt
みたいな感じでリストはファイルに落とせる。ディスクを舐めてinodeを探し出し、ディレクトリもかき集めて名前がわかるファイルはファイル名をフルパスで出してくれます。ディレクトリが切れているファイルはinode番号だけだったり、ディレクトリ抜きのファイル名だけだったりするようです。

xfs_db
-----
標準ツールにxfs_dbというデバッガが付属している。inode番号が分かればこれを使ってinodeの詳細情報を読み出せます。データブロックのアドレスも出してくれます。

これ使えば、ファイルの中身をサルベージできそう。


xfs-fsalvage
-----
そこで作ったのがこのスクリプトです。

xfs_ncheckが吐き出したinodeとファイル名の一覧から、xfs_dbを操ってファイルの中身を読みだし、ディスクに書き込む、ということをします。

xfs-fsalveとxfs_dbのstdin/stdouはpipeで繋いであり 、コマンド文字列を送り、そのレスポンスを得ることでファイルをサルベージします。
ファイルのデータは、ヘキサダンプとして取り出し、バイナリデータに戻しているので、あまり早くはありません。


パラメータ
----
    ./xfs-fsalvage {xfsイメージ} {ファイル書き込みパス}
    標準入力からxfs_ncheckの出力を送り込む。

+xfsイメージ: デバイスファイル名
+ファイル書き込みパス: サルベージしたファイルを書き込むパス。最後はスラッシュで終わること。入力ファイル名と文字列で連結して出力ファイル名を作ります。

例)
    ./xfs-fsalvage /dev/sda7 ./salvage/ < filelist.txt

サルベージしたいパスが決まっているなら
    grep {欲しいパスのパターン} filelist.txt | ./xfs-fsalvage /dev/sda7 ./salvage/ 
のように入力でフィルタリングすればよい。


オプデョン
----
スクリプト内の先頭付近に、スクリプトの挙動を変えるための変数を置いてあります。書き換えて使ってください。

+ $NEWER
 ある日付以降のファイルのみsalvageしたいときに用いる。ファイルコピーなどではmtimeはオリジナルのファイルのものにセットされてしまうので、ctimeと比較している。

+ $SKIPIFEXIST
 すでに書き込み先にあるファイルは処理しない。inodeの読み込みもしません。

+ $PUTDATEONROOTFILE
 rootフォルダにあるファイルは、ファイルのmtimeの日付を先頭に付加する。ディレクトリが壊れたファイルは、フォルダ無しのファイル名がxfs_ncheckから出力されてきます。結果、違うファイルが同じファイル名でxfs_ncheckから出てき得る。
フォルダが無いと、それはrootにあるものとしてサルベージしようとするので、その救済です。mtimeから日付を抜き出し、ファイルの先頭に付加し、サルベージします。私が復元したボリュームは日付の付加で重複を回避できましたが、それでは不十分な場合、この変数手がかりにファイル名の書き換え部分を見つけて書き換えてください。


質問など
-----
私のgithubのアドレス宛にメールください。回答の約束はできませんが、できる範囲での対応はします。
稼働工数いただけるなら、優先して対応いたします。^o^;;

石田 秋也 (株)ラング
